---
import Layout from '../../components/Layout.astro';
import SEO from '../../components/SEO.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	const categories = [...new Set(posts.map(post => post.data.category))];
	return categories.map(cat => ({
		params: { category: cat.toLowerCase().replace(/\s+/g, '-') }
	}));
}

const { category } = Astro.params;
const normalize = (value: string) => value.toLowerCase().replace(/\s+/g, '-');

type BlogEntry = CollectionEntry<'blog'>;
const posts = (await getCollection('blog')) as BlogEntry[];
const filtered = posts.filter((post) => normalize(post.data.category) === normalize(category ?? ''));

if (filtered.length === 0) {
	throw new Response(null, { status: 404 });
}

filtered.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const displayName = filtered[0].data.category;
---
<Layout title={`Category: ${displayName}`} description={`Posts filed under ${displayName}.`}>
	<SEO
		title={`Category: ${displayName}`}
		description={`Offline-ready Astro posts tagged ${displayName}.`}
		image="/pwa-512x512.png"
		url={`https://astro-pwa.example.com/categories/${category}/`}
	/>
	<h1 class="text-3xl font-bold text-slate-900 dark:text-white">Category: {displayName}</h1>
	<p class="text-sm text-slate-500 dark:text-slate-300">{filtered.length} posts</p>
	<ul class="mt-6 space-y-4">
		{filtered.map((post) => (
			<li class="rounded-2xl border border-slate-200 bg-white/80 p-6 shadow-card dark:border-slate-700 dark:bg-slate-900/70">
				<a class="text-2xl font-semibold text-slate-900 dark:text-white" href={`/posts/${post.slug}/`}>
					{post.data.title}
				</a>
				<p class="mt-2 text-sm text-slate-600 dark:text-slate-300">{post.data.description}</p>
				<p class="mt-2 text-xs uppercase tracking-wide text-slate-400 dark:text-slate-500">{post.data.date.toLocaleDateString()}</p>
			</li>
		))}
	</ul>
</Layout>
