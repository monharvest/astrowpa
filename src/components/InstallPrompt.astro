---
const {
	label = 'Install App',
	className = ''
} = Astro.props;
---
<button
	type="button"
	data-install-button
	hidden
	class={`inline-flex items-center gap-2 rounded-full border border-brand-secondary/40 bg-white/80 px-4 py-2 text-sm font-semibold text-brand-secondary shadow-sm transition hover:-translate-y-0.5 hover:bg-white ${className}`}
>
	<span>â‡©</span>
	<span>{label}</span>
</button>
<script is:inline>
	/** @type {HTMLButtonElement | null} */
	const button = document.currentScript?.previousElementSibling;
	let deferredPrompt = null;

	const hideButton = () => {
		button?.setAttribute('hidden', 'hidden');
		button?.classList.remove('animate-pulse');
	};

	const showButton = () => {
		button?.removeAttribute('hidden');
		button?.classList.add('animate-pulse');
	};

	window.addEventListener('beforeinstallprompt', (event) => {
		event.preventDefault();
		deferredPrompt = event;
		showButton();
	});

	button?.addEventListener('click', async () => {
		if (!deferredPrompt) return;
		button.disabled = true;
		await deferredPrompt.prompt();
		const { outcome } = await deferredPrompt.userChoice;
		deferredPrompt = null;
		button.disabled = false;
		if (outcome === 'accepted') {
			hideButton();
		}
	});

	window.addEventListener('appinstalled', () => {
		deferredPrompt = null;
		hideButton();
	});
</script>
