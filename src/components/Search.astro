---
import type { CollectionEntry } from 'astro:content';

type BlogEntry = CollectionEntry<'blog'>;
const searchDomId = `search-${Math.random().toString(36).slice(2, 8)}`;
const { posts = [], title = 'Search posts' } = Astro.props as { posts: BlogEntry[]; title?: string };
const payload = posts.map((post) => ({
	title: post.data.title,
	description: post.data.description,
	slug: post.slug
}));
---
<section data-search-root={searchDomId} class="space-y-4 rounded-2xl border border-slate-200 bg-white/80 p-6 shadow-card dark:border-slate-700 dark:bg-slate-900/70">
	<div>
		<h2 class="text-2xl font-semibold text-slate-900 dark:text-white">{title}</h2>
		<p class="text-sm text-slate-500 dark:text-slate-300">Filter posts instantly while offline.</p>
	</div>
	<input
		data-search-input={searchDomId}
		type="search"
		placeholder="Search posts..."
		class="w-full rounded-lg border border-slate-300 bg-white/90 px-4 py-2 text-slate-900 shadow-sm focus:border-brand-secondary focus:outline-none dark:border-slate-600 dark:bg-slate-800 dark:text-white"
	/>
	<ul data-search-results={searchDomId} class="space-y-3 text-slate-700 dark:text-slate-200">
		{posts.map((post) => (
			<li class="rounded-lg border border-transparent px-3 py-2 transition hover:border-brand-secondary/20 hover:bg-brand-secondary/5 dark:hover:bg-slate-800">
				<a class="font-medium text-brand-secondary dark:text-slate-100" href={`/posts/${post.slug}/`}>
					{post.data.title}
				</a>
				<p class="text-sm text-slate-500 dark:text-slate-400">{post.data.description}</p>
			</li>
		))}
	</ul>
	<script type="application/json" data-search-data={searchDomId}>{JSON.stringify(payload)}</script>
</section>
<script is:inline>
	const searchId = '${searchDomId}';
	const root = document.querySelector(`[data-search-root="${searchId}"]`);
	const input = root?.querySelector(`[data-search-input="${searchId}"]`);
	const resultsEl = root?.querySelector(`[data-search-results="${searchId}"]`);
	const dataEl = root?.querySelector(`[data-search-data="${searchId}"]`);
	const posts = dataEl ? JSON.parse(dataEl.textContent || '[]') : [];

	const renderResults = (items) => {
		return items
			.map(
				(item) => `
			<li class="rounded-lg border border-transparent px-3 py-2 transition hover:border-brand-secondary/20 hover:bg-brand-secondary/5 dark:hover:bg-slate-800">
				<a class="font-medium text-brand-secondary dark:text-slate-100" href="/posts/${item.slug}/">${item.title}</a>
				<p class="text-sm text-slate-500 dark:text-slate-400">${item.description}</p>
			</li>`
			)
			.join('');
	};

	input?.addEventListener('input', (event) => {
		const value = event.target.value.toLowerCase();
		const filtered = posts.filter((post) =>
			post.title.toLowerCase().includes(value) ||
			post.description.toLowerCase().includes(value)
		);
		resultsEl && (resultsEl.innerHTML = renderResults(filtered));
	});
</script>
