---
const { className = '' } = Astro.props;
const steps = [
	'1. Tap the share icon in Safari (square with upward arrow).',
	'2. Scroll the sheet and pick "Add to Home Screen".',
	'3. Confirm the name and tap "Add" to install the app icon.'
];
---
<section class={`w-full space-y-4 ${className}`} data-platform-cta>
	<p class="text-sm uppercase tracking-[0.3em] text-white/80">Install Options</p>
	<div class="flex flex-wrap gap-3">
		<button
			type="button"
			data-platform-button="ios"
			class="flex-1 min-w-[140px] rounded-2xl border border-white/40 bg-white/10 px-5 py-3 text-left text-white transition hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white/70"
		>
			<p class="text-xs uppercase tracking-widest text-white/70">iPhone</p>
			<p class="text-lg font-semibold">Add to Home Screen</p>
		</button>
		<button
			type="button"
			data-platform-button="android"
			class="flex-1 min-w-[140px] rounded-2xl border border-white/40 bg-white/10 px-5 py-3 text-left text-white transition hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white/70"
		>
			<p class="text-xs uppercase tracking-widest text-white/70">Android</p>
			<p class="text-lg font-semibold">Install with Chrome</p>
		</button>
		<button
			type="button"
			data-platform-button="web"
			class="flex-1 min-w-[140px] rounded-2xl border border-white/40 bg-white/10 px-5 py-3 text-left text-white transition hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white/70"
		>
			<p class="text-xs uppercase tracking-widest text-white/70">Web 3</p>
			<p class="text-lg font-semibold">Open in Browser</p>
		</button>
	</div>
	<div data-ios-panel hidden class="rounded-2xl border border-white/30 bg-white/90 p-5 text-slate-900 shadow-card">
		<div class="flex items-center justify-between">
			<p class="text-lg font-semibold">Install on iPhone</p>
			<button data-ios-close type="button" class="text-sm font-semibold text-slate-500 hover:text-slate-900">Close</button>
		</div>
		<ul class="mt-4 space-y-2 text-sm text-slate-600">
			{steps.map((step) => (
				<li class="flex gap-2">
					<span class="text-brand-secondary">•</span>
					<span>{step}</span>
				</li>
			))}
		</ul>
	</div>
	<div data-toast hidden class="rounded-full border border-white/30 bg-white/20 px-5 py-2 text-sm font-semibold text-white">
		<span data-toast-message>Installing…</span>
	</div>
</section>
<script is:inline>
	(function() {
		const root = document.currentScript?.parentElement;
		if (!root) return;
		
		const buttons = root.querySelectorAll('[data-platform-button]');
		const iosButton = root.querySelector('[data-platform-button="ios"]');
		const androidButton = root.querySelector('[data-platform-button="android"]');
		const webButton = root.querySelector('[data-platform-button="web"]');
		const iosPanel = root.querySelector('[data-ios-panel]');
		const iosClose = root.querySelector('[data-ios-close]');
		const toast = root.querySelector('[data-toast]');
		const toastMessage = root.querySelector('[data-toast-message]');
		
		let deferredPrompt = null;

		const highlightPlatform = () => {
			const ua = navigator.userAgent.toLowerCase();
			let target = 'web';
			if (/iphone|ipad|ipod/.test(ua)) {
				target = 'ios';
			} else if (/android/.test(ua)) {
				target = 'android';
			}
			
			buttons.forEach((button) => {
				const value = button.getAttribute('data-platform-button');
				if (value === target) {
					button.classList.add('ring-2', 'ring-white/70');
				} else {
					button.classList.remove('ring-2', 'ring-white/70');
				}
			});
		};

		const showToast = (message, duration = 4000) => {
			if (!toast || !toastMessage) return;
			toastMessage.textContent = message;
			toast.hidden = false;
			setTimeout(() => {
				toast.hidden = true;
			}, duration);
		};

		window.addEventListener('beforeinstallprompt', (event) => {
			event.preventDefault();
			deferredPrompt = event;
			showToast('Android install ready. Tap the Android button to continue.', 6000);
		});

		if (iosButton) {
			iosButton.addEventListener('click', () => {
				if (iosPanel) {
					iosPanel.hidden = false;
				}
			});
		}

		if (iosClose) {
			iosClose.addEventListener('click', () => {
				if (iosPanel) {
					iosPanel.hidden = true;
				}
			});
		}

		if (androidButton) {
			androidButton.addEventListener('click', async () => {
				if (!deferredPrompt) {
					showToast('Open this site in Chrome or Edge on Android to install.');
					return;
				}
				androidButton.disabled = true;
				try {
					await deferredPrompt.prompt();
					const { outcome } = await deferredPrompt.userChoice;
					if (outcome === 'accepted') {
						showToast('Awesome! Check your home screen for the new icon.', 5000);
						deferredPrompt = null;
					} else {
						showToast('No worries. You can install any time from this button.');
					}
				} catch (err) {
					showToast('Installation not available on this browser.');
				} finally {
					androidButton.disabled = false;
				}
			});
		}

		if (webButton) {
			webButton.addEventListener('click', async () => {
				try {
					if (navigator.clipboard && navigator.clipboard.writeText) {
						await navigator.clipboard.writeText(window.location.href);
						showToast('Link copied. Open it in any browser or Web3 wallet.');
					} else {
						showToast('Stay in the browser for the full experience—no install needed.');
					}
				} catch (_error) {
					showToast('Stay in the browser for the full experience—no install needed.');
				}
			});
		}

		document.addEventListener('click', (event) => {
			if (!iosPanel || iosPanel.hidden) return;
			const target = event.target;
			if (target === iosPanel || iosPanel.contains(target)) return;
			if (target === iosButton || iosButton.contains(target)) return;
			iosPanel.hidden = true;
		});

		highlightPlatform();
	})();
</script>
